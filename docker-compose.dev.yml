version: "3.8"

services:
  # --- 1. THE BRAIN (Manager API) ---
  manager:
    build: ./apps/manager
    container_name: sv-manager-dev
    restart: unless-stopped
    environment: 
       - DOMAIN_NAME=${CODESPACE_NAME}-80.app.github.dev # Keep this for IDX dynamic URL logic
       # Do NOT list MODE here. Let it load from env_file below.
    env_file: .env
    volumes:
      - ./apps/manager:/app
      - ./apps/shared:/app/shared
      - ./data/sessions:/app/sessions
      - /var/run/docker.sock:/var/run/docker.sock
    logging:
        driver: "json-file"
        options:
            max-size: "10m"
            max-file: "3"
    networks:
      - sv-internal

  # --- 2. THE GATEWAY (Handover Logic) ---
  gateway:
    build: ./apps/gateway
    container_name: sv-gateway-dev
    restart: unless-stopped
    ports:
      - "8080:80"
    env_file: .env
    environment:
      - SECURE_LINK_SECRET=${SECURE_LINK_SECRET} # Pulls from your .env
    volumes:
      - ./data/cache:/var/cache/nginx/streamvault
    # depends_on:
    #   - manager
    logging:
        driver: "json-file"
        options:
            max-size: "10m"
            max-file: "3"
    networks:
      - sv-internal

  # --- 3. VIDEO WORKER (StreamVault Ingestion) ---
  worker-video:
    build: ./apps/worker-video
    container_name: sv-worker-video-dev
    environment:
      - WORKER_ID=video_1
      - SESSION_FILE=worker_video_1
    env_file: .env
    volumes:
      - ./apps/worker-video:/app
      - ./apps/shared:/app/shared
      - ./data/sessions:/app/sessions # Shared session mount
    # depends_on:
    #   - manager
    logging:
        driver: "json-file"
        options:
            max-size: "10m"
            max-file: "3"
    networks:
      - sv-internal

  # --- 4. MANGA WORKER (ReadVault Librarian) ---
  # worker-manga:
  #   image: python:3.10-slim # Placeholder until we write code
  #   container_name: sv-worker-manga-dev
  #   command: ["tail", "-f", "/dev/null"]
  #   logging:
  #       driver: "json-file"
  #       options:
  #           max-size: "10m"
  #           max-file: "3"
  #   networks:
  #     - sv-internal

  # --- 5. THE ENGINE (The Muscle) ---
  stream-engine:
    build: ./apps/stream-engine
    container_name: sv-stream-engine-dev
    environment:
      - TG_API_ID=${TG_API_ID}
      - TG_API_HASH=${TG_API_HASH}
      - TG_BOT_TOKEN=${TG_BOT_TOKEN}           # Fallback
      - TG_SESSION_STRING=${TG_SESSION_STRING} # <--- NEW: The Userbot Login Key
    volumes:
      # This stores the "Brain" (Peer/Channel Cache) so it doesn't forget hashes
      - ./data/sessions:/app/sessions 
    env_file: .env
    expose:
      - 8000
    logging:
        driver: "json-file"
        options:
            max-size: "10m"
            max-file: "3"
    networks:
      - sv-internal


  # --- 6. THE FACE (Frontend Placeholder) ---
  # web:
  #   image: node:20-alpine
  #   container_name: sv-web-dev
  #   command: [ "sh", "-c", "echo 'NextJS Waiting...' && tail -f /dev/null" ]
  #   logging:
  #       driver: "json-file"
  #       options:
  #           max-size: "10m"
  #           max-file: "3"
  #   networks:
  #     - sv-internal

networks:
  sv-internal:
    driver: bridge
