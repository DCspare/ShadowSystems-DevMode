version: "3.8"

services:
  # --- 1. THE GATEWAY (Nginx Proxy) ---
  gateway:
    build: ./apps/gateway
    container_name: sv-gateway-dev
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./apps/gateway/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./data/cache:/var/cache/nginx/streamvault
    depends_on:
      - manager
    networks:
      - sv-internal

  # --- 2. THE BRAIN (Manager API) ---
  manager:
    build: ./apps/manager
    container_name: sv-manager-dev
    environment:
      - MODE=DEV
    env_file: .env
    volumes:
      - ./apps/manager:/app
      - ./data/sessions:/app/sessions
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - sv-internal

  # --- 3. VIDEO WORKER (StreamVault Ingestion) ---
  worker-video:
    build: ./apps/worker-video
    container_name: sv-worker-video-dev
    environment:
      - WORKER_ID=video_1
      - SESSION_FILE=worker_video_1
    env_file: .env
    volumes:
      - ./apps/worker-video:/app
      - ./data/sessions:/app/sessions # Shared session mount
    depends_on:
      - manager
    networks:
      - sv-internal

  # --- 4. MANGA WORKER (ReadVault Librarian) ---
  worker-manga:
    image: python:3.10-slim # Placeholder until we write code
    container_name: sv-worker-manga-dev
    command: ["tail", "-f", "/dev/null"]
    networks:
      - sv-internal

  # --- 5. THE FACE (Frontend Placeholder) ---
  web:
    image: node:20-alpine
    container_name: sv-web-dev
    command: ["sh", "-c", "echo 'NextJS Waiting...' && tail -f /dev/null"]
    networks:
      - sv-internal

networks:
  sv-internal:
    driver: bridge
