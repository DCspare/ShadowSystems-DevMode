services:
  # --- 1. THE BRAIN (Manager API) ---
  manager:
    build: ./apps/manager
    container_name: sv-manager-dev
    restart: unless-stopped
    env_file: .env
    environment: 
       - DOMAIN_NAME=${DOMAIN_NAME} # Keep this for IDX dynamic URL logic
       - WORKER_MODE=BOT            # ðŸ‘¤ Manager uses the User Identity for muscle (USER vs BOT)
       - SESSION_FILE=manager       # .session file name in ./data/sessions
    volumes:
      - ./apps/manager:/app
      - ./apps/shared:/app/shared
      - ./data/sessions:/app/sessions
      - /var/run/docker.sock:/var/run/docker.sock
    logging:
        driver: "json-file"
        options:
            max-size: "10m"
            max-file: "3"
    networks:
      - sv-internal

  # --- 2. THE GATEWAY (Handover Logic) ---
  gateway:
    build: ./apps/gateway
    container_name: sv-gateway-dev
    restart: unless-stopped
    ports:
      - "8080:80"
    env_file: .env
    environment:
      - SECURE_LINK_SECRET=${SECURE_LINK_SECRET} # Pulls from your .env
    volumes:
      - ./data/cache:/var/cache/nginx/streamvault
    depends_on:
      - manager
    logging:
        driver: "json-file"
        options:
            max-size: "10m"
            max-file: "3"
    networks:
      - sv-internal

  # --- 3. VIDEO WORKER (StreamVault Ingestion) ---
  worker-video:
    build: ./apps/worker-video
    container_name: sv-worker-video-dev
    env_file: .env
    environment:
      - WORKER_MODE=BOT         # ðŸ¤– Worker stays as Bot only
      - SESSION_FILE=leech_1    # .session file name in ./data/sessions
    volumes:
      - ./apps/worker-video:/app
      - ./apps/shared:/app/shared
      - ./data/sessions:/app/sessions # Shared session mount
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - manager
    logging:
        driver: "json-file"
        options:
            max-size: "10m"
            max-file: "3"
    networks:
      - sv-internal

  # --- 4. MANGA WORKER (ReadVault Librarian) ---
  # worker-manga:
  #   image: python:3.10-slim # Placeholder until we write code
  #   container_name: sv-worker-manga-dev
  #   command: ["tail", "-f", "/dev/null"]
  #   logging:
  #       driver: "json-file"
  #       options:
  #           max-size: "10m"
  #           max-file: "3"
  #   networks:
  #     - sv-internal

  # --- 5. THE ENGINE (The GO Stream) ---
  stream-engine:
    build: ./apps/stream-engine
    container_name: sv-stream-engine-dev
    env_file: .env
    environment:
      - TG_API_ID=${TG_API_ID}
      - TG_API_HASH=${TG_API_HASH}
      - TG_STREAM_BOT_TOKEN=${TG_STREAM_BOT_TOKEN} # Priority
      - TG_SESSION_STRING=${TG_SESSION_STRING} # Fallback
    volumes:
      - ./data/sessions:/app/sessions # Shared session mount
      - /var/run/docker.sock:/var/run/docker.sock 
    expose:
      - 8000
    logging:
        driver: "json-file"
        options:
            max-size: "10m"
            max-file: "3"
    networks:
      - sv-internal


  # --- 6. THE FACE (Frontend Placeholder) ---
  # web:
  #   image: node:20-alpine
  #   container_name: sv-web-dev
  #   command: [ "sh", "-c", "echo 'NextJS Waiting...' && tail -f /dev/null" ]
  #   logging:
  #       driver: "json-file"
  #       options:
  #           max-size: "10m"
  #           max-file: "3"
  #   networks:
  #     - sv-internal

networks:
  sv-internal:
    driver: bridge
